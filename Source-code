package fr.maxence.pluginstaff;

import org.bukkit.plugin.java.JavaPlugin;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.GameMode;
import org.bukkit.Material;
import org.bukkit.command.Command;
import org.bukkit.command.CommandExecutor;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.inventory.Inventory;
import org.bukkit.inventory.ItemStack;
import org.bukkit.permissions.PermissionAttachment;

import java.util.HashMap;
import java.util.UUID;

public class StaffPlugin extends JavaPlugin implements CommandExecutor {

    private final HashMap<UUID, PermissionAttachment> permissions = new HashMap<>();
    private final HashMap<UUID, ItemStack[]> inventories = new HashMap<>();

    @Override
    public boolean onCommand(CommandSender sender, Command cmd, String label, String[] args) {

        if (cmd.getName().equalsIgnoreCase("onstaff") && sender instanceof Player) {
            Player player = (Player) sender;
            // Vérifie si le joueur est déjà en mode staff
            if (permissions.containsKey(player.getUniqueId())) {
                player.sendMessage(ChatColor.RED + "Vous êtes déjà en mode staff !");
                return true;
            }

            // Récupère la permission et l'inventaire du grade du joueur
            String group = getGroup(player);
            PermissionAttachment attachment = player.addAttachment(this);
            permissions.put(player.getUniqueId(), attachment);
            Bukkit.getServer().dispatchCommand(Bukkit.getServer().getConsoleSender(),
                    "lp user " + player.getName() + " group set" + group);
            Bukkit.getServer().dispatchCommand(Bukkit.getServer().getConsoleSender(),
            		"lp user " + player.getName() + " permission unset minecraft.inventory.drop");
            Bukkit.getServer().dispatchCommand(Bukkit.getServer().getConsoleSender(),
            		"lp user " + player.getName() + " permission unset minecraft.container.access");
            Bukkit.getServer().dispatchCommand(Bukkit.getServer().getConsoleSender(),
            		"lp user " + player.getName() + " permission set essentials.vanish");

            inventories.put(player.getUniqueId(), player.getInventory().getContents());
            player.getInventory().clear();
            giveStaffItems(player);

            player.sendMessage(ChatColor.GREEN + "Vous êtes maintenant en mode staff !");
            return true;
        }

        if (cmd.getName().equalsIgnoreCase("offstaff") && sender instanceof Player) {
            Player player = (Player) sender;
            // Vérifie si le joueur est en mode staff
            if (!permissions.containsKey(player.getUniqueId())) {
                player.sendMessage(ChatColor.RED + "Vous n'êtes pas en mode staff !");
                return true;
            }

            // Restaure les permissions et l'inventaire du joueur
            player.removeAttachment(permissions.get(player.getUniqueId()));
            permissions.remove(player.getUniqueId());
            Bukkit.getServer().dispatchCommand(Bukkit.getServer().getConsoleSender(),
                    "lp user " + player.getName() + " group set " + getGroup(player));
            Bukkit.getServer().dispatchCommand(Bukkit.getServer().getConsoleSender(),
            		"lp user " + player.getName() + " permission set minecraft.inventory.drop");
            Bukkit.getServer().dispatchCommand(Bukkit.getServer().getConsoleSender(),
            		"lp user " + player.getName() + " permission set minecraft.container.access");
            Bukkit.getServer().dispatchCommand(Bukkit.getServer().getConsoleSender(),
            		"lp user " + player.getName() + " permission unset essentials.vanish");

            player.getInventory().clear();
            ItemStack[] inventoryContents = inventories.get(player.getUniqueId());
            if (inventoryContents != null) {
                player.getInventory().setContents(inventoryContents);
            }

            player.setGameMode(GameMode.SURVIVAL);
            player.sendMessage(ChatColor.GREEN + "Vous n'êtes plus en mode staff !");
            return true;
        }

        return false;
    }

    private void giveStaffItems(Player player) {
        // Ajoute des items au joueur en mode staff
        player.getInventory().addItem(new ItemStack(Material.DIAMOND_SWORD));
        player.setGameMode(GameMode.CREATIVE);
    }

    private String getGroup(Player player) {
        // Retourne le nom du groupe correspondant au grade du joueur
        if (player.isOp()) {
            return "adminisateur";
        } else if (player.hasPermission("group.administrateur")) {
            return "administrateur";
        } else if (player.hasPermission("group.responsable")) {
            return "responsable";
        } else if (player.hasPermission("group.super_moderateur")) {
        	return "super_moderateur";
        } else if (player.hasPermission("group.moderateur")) {
        	return "moderateur";
        } else if (player.hasPermission("group.developpeur")) {
        	return "developpeur";
        } else if (player.hasPermission("group.buildeur")) {
        	return "buildeur";
        } else return "default" ;
    }
}
